Bootstrap: debootstrap
MirrorURL: http://archive.ubuntu.com/ubuntu/
OSVersion: bionic
Include: software-properties-common

%labels

    APPLICATION_NAME Simple Features R Spatial
    OS_VERSION Ubuntu 18.04
    APPLICATION_URL http://r-spatial.github.io/sf/

    SYSTEM_NAME UCT ICTS HPC 
    SYSTEM_SINGULARITY_VERSION 3.2
    SYSTEM_URL http://hpc.uct.ac.za

    AUTHOR_NAME Timothy Carr
    AUTHOR_EMAIL timothy.carr@uct.ac.za

%environment
    # Set system locale
    export LC_ALL=C
    export R_LIBS=/usr/local/lib/R/site-library
    export R_INCLUDE_DIR=/usr/share/R/include
     
%post
    apt-add-repository universe
    apt update -y
    apt install -y software-properties-common
    
    # R SP/SF Installation and Configuration. 
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
    add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/'
    apt update 
    apt upgrade -y

    export DEBIAN_FRONTEND=noninteractive; apt-get -y update --allow-unauthenticated \
    && apt-get install -y --allow-unauthenticated \
        libcurl4-openssl-dev \
        qpdf \
        pandoc \
        make \
        wget \
        git \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        liblwgeom-dev \
        libudunits2-dev \
        libglu1-mesa-dev \
        postgis \
        r-base-dev

    apt install -y texinfo --allow-unauthenticated \
       texlive-base \
       texlive-extra-utils \
       texlive-fonts-extra \
       texlive-fonts-recommended \
       texlive-generic-recommended \
       texlive-latex-base \
       texlive-latex-extra \
       texlive-latex-recommended
    
    # Installation of ttmaptools/rmapshaper/geojsonio
    apt install -y libv8-3.14-dev libprotobuf-dev protobuf-compiler libcairo2-dev
    add-apt-repository -y ppa:opencpu/jq
    apt update -y 
    apt install -y libjq-dev pandoc pandoc-citeproc

    # Install R package dependencies     
    git clone https://github.com/r-spatial/sf.git
    R CMD build --no-build-vignettes sf
    R CMD INSTALL sf_*tar.gz
    apt install -y pandoc pandoc-citeproc
    Rscript -e 'install.packages(c("lwgeom", "covr", "raster"), dependencies = TRUE, repos = "https://cloud.r-project.org")'

    # Clean Up 
    apt clean
    apt autoclean
    apt autoremove -y 

%help 
    This is a SF with R core version 3.6 container. 

%test
    # The following tests will be used to test the functionality of the container build
    # and the results fed into the CI Jenkins platform