Bootstrap: debootstrap
MirrorURL: http://archive.ubuntu.com/ubuntu/
OSVersion: xenial
Include: software-properties-common

%labels

    APPLICATION_NAME Simple Features R Spatial
    OS_VERSION Ubuntu 16.04
    APPLICATION_URL http://r-spatial.github.io/sf/

    SYSTEM_NAME UCT ICTS HPC
    SYSTEM_SINGULARITY_VERSION 3.2
    SYSTEM_URL http://hpc.uct.ac.za

    AUTHOR_NAME Timothy Carr
    AUTHOR_EMAIL timothy.carr@uct.ac.za

%environment
    # Set system locale
    export LC_ALL=C
     
%post -c /bin/bash

    # Update Ubuntu Cache and begin install
    apt-add-repository universe
    apt update -y
    apt install -y software-properties-common
    
    # R SP/SF Installation and Configuration. 
    add-apt-repository ppa:ubuntugis/ubuntugis-unstable
    add-apt-repository 'deb http://cloud.r-project.org/bin/linux/ubuntu xenial-cran35/'
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
    apt update 
    apt upgrade -y

    export DEBIAN_FRONTEND=noninteractive; apt-get -y update --allow-unauthenticated \
    && apt-get install -y --allow-unauthenticated \
        libcurl4-openssl-dev \
        qpdf \
        pandoc \
        make \
        wget \
        git \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        liblwgeom-dev \
        libudunits2-dev \
        postgis \
        r-base-dev

    apt install -y texinfo --allow-unauthenticated \
       texlive-base \
       texlive-extra-utils \
       texlive-fonts-extra \
       texlive-fonts-recommended \
       texlive-generic-recommended \
       texlive-latex-base \
       texlive-latex-extra \
       texlive-latex-recommended
    
    # Installation of ttmaptools/rmapshaper/geojsonio
    apt install -y libv8-3.14-dev libprotobuf-dev protobuf-compiler libcairo2-dev
    add-apt-repository -y ppa:opencpu/jq
    apt update -y 
    apt install -y libjq-dev

    # Install R package dependencies 
    Rscript -e 'install.packages(c("sf", "lwgeom", "covr", "raster"), dependencies = TRUE, repos = "https://cloud.r-project.org")'    
    git clone   https://github.com/r-spatial/sf.git
    R CMD build --no-build-vignettes sf
    R CMD INSTALL sf_*tar.gz
    apt install -y pandoc pandoc-citeproc
    R CMD check --as-cran sf_*tar.gz

    # Clean Up 
    apt clean
    apt autoclean
    apt autoremove -y 

%help 
    This is a SF with R core version 3.6 container. 


%test
    # The following tests will be used to test the functionality of the container build
    # and the results fed into the CI Jenkins platform